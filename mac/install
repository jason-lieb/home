#!/bin/bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

echo "=== Mac Setup ==="

# ============================================
# Homebrew
# ============================================
if ! command -v brew &>/dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    if [[ -f /opt/homebrew/bin/brew ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -f /usr/local/bin/brew ]]; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi
else
    echo "Homebrew already installed"
fi

echo "Installing packages from Brewfile..."
brew bundle --file="$SCRIPT_DIR/Brewfile"

# ============================================
# Touch ID for sudo
# ============================================
SUDO_LOCAL="/etc/pam.d/sudo_local"
if ! grep -q "pam_tid.so" "$SUDO_LOCAL" 2>/dev/null; then
    echo "Enabling Touch ID for sudo (requires sudo)..."
    echo "auth       sufficient     pam_tid.so" | sudo tee -a "$SUDO_LOCAL" > /dev/null
fi

# ============================================
# Dotfiles (shared)
# ============================================
"$REPO_DIR/dotfiles/install"

echo ""
echo "=== Mac Setup Complete ==="
