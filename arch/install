#!/bin/bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TARGET_USER="jason"

usage() {
  cat <<'EOF'
Usage:
  ./install          Run core modules
  ./install --all    Run core + optional modules

EOF
}

RUN_ALL=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --all)
      RUN_ALL=true
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown argument: $1" >&2
      usage
      exit 1
      ;;
  esac
done

export TARGET_USER

echo "=== Arch Linux Post-Install Setup ==="

echo "=== Preflight Checks ==="
if [[ "$EUID" -eq 0 ]]; then
  echo "ERROR: Run install as your normal user, not root."
  echo "The scripts will use sudo when needed."
  exit 1
fi

if ! command -v sudo >/dev/null 2>&1; then
  echo "ERROR: sudo is required."
  exit 1
fi

if ! sudo -n true 2>/dev/null; then
  echo "sudo access required; you may be prompted for password..."
  sudo -v
fi

if ! id "$TARGET_USER" >/dev/null 2>&1; then
  echo "ERROR: target user '$TARGET_USER' does not exist."
  exit 1
fi

for cmd in git curl; do
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo "ERROR: missing required command '$cmd'."
    exit 1
  fi
done

echo "Preflight checks passed."
echo ""

CORE_MODULES=(
  packages
  dotfiles
  services
  plasma
  session-defaults
)

OPTIONAL_MODULES=(
  syncthing
  gaming
)

for name in "${CORE_MODULES[@]}"; do
  echo "Running ${name}..."
  bash "$SCRIPT_DIR/modules/${name}.sh"
  echo ""
done

if [[ "$RUN_ALL" == true ]]; then
  for name in "${OPTIONAL_MODULES[@]}"; do
    echo "Running optional/${name}..."
    bash "$SCRIPT_DIR/modules/optional/${name}.sh"
    echo ""
  done
fi

echo "=== Setup Complete ==="
echo "Please reboot to apply all changes."
